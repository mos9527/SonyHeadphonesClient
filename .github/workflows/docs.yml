# This workflow builds a CMake project and deploys the specified
# 'build/client/' directory to GitHub Pages.
# Written by Gemini 2.5 Pro
name: Deploy Client to GitHub Pages

on:
  # Runs on pushes targeting the default branch
  push:
    branches: ["rewrite"]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Build Dependencies
        # Add any other libraries your project needs here
        # build-essential and cmake are still needed by emscripten/cmake itself
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Setup Emscripten
        # Installs the Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14

      - name: Configure CMake
        # This creates the 'build' directory
        # We use 'emcmake' which is a wrapper provided by the Emscripten SDK
        # to configure CMake with the correct Emscripten toolchain.
        run: emcmake cmake -B build -S .

      - name: Build Project Target
        # This builds your 'SonyHeadphonesClient' target
        # which you said generates the 'build/client/' files.
        run: cmake --build build --target SonyHeadphonesClient

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          # This is the path you specified
          path: 'build/client/'

  # Deployment job
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

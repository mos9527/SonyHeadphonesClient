// TODO: Response commands? Do we still need those?
#include <map>
#include "Codegen.hpp"

std::string gSrc = "libmdr/ProtocolV2T1Enums.hpp";
std::string gNamespaceName = "mdr::v2::t1";
std::map<std::string, std::string> gNamespaceToDataTypeMapping = {
    {"mdr::v2::t1", "MDRDataType::DATA_MDR"},
    {"mdr::v2::t2", "MDRDataType::DATA_MDR_NO2"}
};
CXChildVisitResult structVisitor(CXCursor cursor, CXCursor parent, CXClientData)
{
    CXCursorKind kind = clang_getCursorKind(cursor);
    switch (kind)
    {
    case CXCursor_Namespace:
        return CXChildVisit_Recurse;
    case CXCursor_StructDecl:
    {
        std::string parentStr = getFullParentName(parent);
        if (parentStr != gNamespaceName)
            return CXChildVisit_Continue;
        CXString name = clang_getCursorSpelling(cursor);
        std::string structName = clang_getCString(name);
        clang_disposeString(name);
        println("    template<> struct MDRTraits<{}::{}> {{", parentStr.substr(5 /* mdr:: */), structName);
        println("        static constexpr MDRDataType kDataType = {};", gNamespaceToDataTypeMapping[parentStr]);
        println("    }};");
        return CXChildVisit_Continue;
    }
    default:
        return CXChildVisit_Continue;
    }
}

int main( int argc, char** argv )
{
    if (argc != 3)
    {
        println("usage: {} <source-file> <namespace-name>", argv[0]);
        println("\tGenerate MDRTraits for the given source file and namespace name.");
        println("\tOutput is printed to stdout.");
        return 1;
    }
    gSrc = argv[1];
    gNamespaceName = argv[2];
    CXIndex index = clang_createIndex(0, 0);
    CXTranslationUnit unit = clang_parseTranslationUnit(
        index,
        gSrc.c_str(),
        nullptr, 0,
        nullptr, 0,
        CXTranslationUnit_DetailedPreprocessingRecord);
    CXCursor cursor = clang_getTranslationUnitCursor(unit);
    println("/* This file is auto-generated by tooling/TraitsCodegen.cpp */");
    println("#pragma once");
    println("");
    println("namespace mdr {{");
    clang_visitChildren(cursor, structVisitor, nullptr);
    println("}}");

    clang_disposeTranslationUnit(unit);
    clang_disposeIndex(index);
    return 0;
}
